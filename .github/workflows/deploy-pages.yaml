name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master
    paths:
      - 'languages/**'
      - '.github/workflows/build.yaml'
      - '.github/workflows/deploy-pages.yaml'
  workflow_dispatch:
  workflow_call:
    outputs:
      pages_url:
        description: "GitHub Pages URL where CVs are deployed"
        value: ${{ jobs.deploy.outputs.page_url }}

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    uses: ./.github/workflows/build.yaml

  deploy:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: Checkout repository for README update
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare deployment directory
        run: |
          mkdir -p public

          # Rename files to use language codes (en.pdf, pt.pdf, etc)
          if [ -f artifacts/lang_mapping.txt ]; then
            while IFS=: read -r PDF_FILE LANG_CODE; do
              HTML_FILE="${PDF_FILE%.pdf}.html"

              # Copy and rename to language code
              cp "artifacts/${PDF_FILE}" "public/${LANG_CODE}.pdf"
              cp "artifacts/${HTML_FILE}" "public/${LANG_CODE}.html"

              echo "Renamed: $PDF_FILE -> ${LANG_CODE}.pdf"
              echo "Renamed: $HTML_FILE -> ${LANG_CODE}.html"
            done < artifacts/lang_mapping.txt
          fi

          echo ""
          echo "Files in public directory:"
          ls -lh public/

      - name: Generate README.md
        run: |
          # Get GitHub Pages URL
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          PAGES_URL="https://${OWNER}.github.io/${REPO}"

          # Language code to display name mapping
          declare -A LANG_NAMES
          LANG_NAMES["en"]="ðŸ‡ºðŸ‡¸ English"
          LANG_NAMES["pt"]="ðŸ‡§ðŸ‡· Portuguese"
          LANG_NAMES["es"]="ðŸ‡ªðŸ‡¸ Spanish"
          LANG_NAMES["fr"]="ðŸ‡«ðŸ‡· French"
          LANG_NAMES["de"]="ðŸ‡©ðŸ‡ª German"
          LANG_NAMES["it"]="ðŸ‡®ðŸ‡¹ Italian"
          LANG_NAMES["ja"]="ðŸ‡¯ðŸ‡µ Japanese"
          LANG_NAMES["zh"]="ðŸ‡¨ðŸ‡³ Chinese"

          # Start README
          cat > repo/README.md << 'EOF'
          # Curriculum Vitae

          | Language | Preview (HTML) | PDF |
          |----------|----------------|------|
          EOF

          # Generate rows for each language
          if [ -f artifacts/lang_mapping.txt ]; then
            while IFS=: read -r PDF_FILE LANG_CODE; do
              # Get display name from mapping, fallback to code
              LANG_DISPLAY="${LANG_NAMES[$LANG_CODE]:-$LANG_CODE}"

              # Use language code for URLs (en.pdf, pt.html, etc)
              echo "| $LANG_DISPLAY | [Preview](${PAGES_URL}/${LANG_CODE}.html) | [Download](${PAGES_URL}/${LANG_CODE}.pdf) |" >> repo/README.md
            done < artifacts/lang_mapping.txt
          fi

          # Add footer
          cat >> repo/README.md << 'EOF'

          ---

          *Built with [RenderCV](https://rendercv.com)*
          EOF

      - name: Create index.html
        run: |
          # Language code to display name mapping
          declare -A LANG_NAMES
          LANG_NAMES["en"]="ðŸ‡ºðŸ‡¸ English"
          LANG_NAMES["pt"]="ðŸ‡§ðŸ‡· Portuguese"
          LANG_NAMES["es"]="ðŸ‡ªðŸ‡¸ Spanish"
          LANG_NAMES["fr"]="ðŸ‡«ðŸ‡· French"
          LANG_NAMES["de"]="ðŸ‡©ðŸ‡ª German"
          LANG_NAMES["it"]="ðŸ‡®ðŸ‡¹ Italian"
          LANG_NAMES["ja"]="ðŸ‡¯ðŸ‡µ Japanese"
          LANG_NAMES["zh"]="ðŸ‡¨ðŸ‡³ Chinese"

          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Curriculum Vitae</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 {
                      border-bottom: 2px solid #333;
                      padding-bottom: 10px;
                  }
                  table {
                      width: 100%;
                      border-collapse: collapse;
                      margin: 30px 0;
                  }
                  th, td {
                      padding: 12px;
                      text-align: left;
                      border-bottom: 1px solid #ddd;
                  }
                  th {
                      background-color: #f5f5f5;
                      font-weight: 600;
                  }
                  a {
                      color: #0066cc;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .footer {
                      margin-top: 50px;
                      padding-top: 20px;
                      border-top: 1px solid #ddd;
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <h1>Curriculum Vitae</h1>
              <table>
                  <thead>
                      <tr>
                          <th>Language</th>
                          <th>Preview (HTML)</th>
                          <th>PDF</th>
                      </tr>
                  </thead>
                  <tbody>
          EOF

          # Generate table rows using language mapping
          if [ -f artifacts/lang_mapping.txt ]; then
            while IFS=: read -r PDF_FILE LANG_CODE; do
              # Get display name from mapping, fallback to code
              LANG_DISPLAY="${LANG_NAMES[$LANG_CODE]:-$LANG_CODE}"

              # Use language code for filenames (en.pdf, pt.html, etc)
              cat >> public/index.html << EOF
                      <tr>
                          <td>$LANG_DISPLAY</td>
                          <td><a href="${LANG_CODE}.html">Preview</a></td>
                          <td><a href="${LANG_CODE}.pdf">Download</a></td>
                      </tr>
          EOF
            done < artifacts/lang_mapping.txt
          fi

          cat >> public/index.html << 'EOF'
                  </tbody>
              </table>
              <div class="footer">
                  <em>Built with <a href="https://rendercv.com" target="_blank" rel="noopener">RenderCV</a></em>
              </div>
          </body>
          </html>
          EOF

      - name: Commit updated README
        run: |
          cd repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to README.md"
          else
            git commit -m "docs: Update CV links in README [skip ci]"
            git push
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        env:
          PAGES_URL: ${{ steps.deployment.outputs.page_url }}
        run: |
          # Language code to display name mapping
          declare -A LANG_NAMES
          LANG_NAMES["en"]="ðŸ‡ºðŸ‡¸ English"
          LANG_NAMES["pt"]="ðŸ‡§ðŸ‡· Portuguese"
          LANG_NAMES["es"]="ðŸ‡ªðŸ‡¸ Spanish"
          LANG_NAMES["fr"]="ðŸ‡«ðŸ‡· French"
          LANG_NAMES["de"]="ðŸ‡©ðŸ‡ª German"
          LANG_NAMES["it"]="ðŸ‡®ðŸ‡¹ Italian"
          LANG_NAMES["ja"]="ðŸ‡¯ðŸ‡µ Japanese"
          LANG_NAMES["zh"]="ðŸ‡¨ðŸ‡³ Chinese"

          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Landing Page" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[${PAGES_URL}](${PAGES_URL})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ CV Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | HTML | PDF |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|-----|" >> $GITHUB_STEP_SUMMARY

          # Generate summary rows using language mapping
          if [ -f artifacts/lang_mapping.txt ]; then
            while IFS=: read -r PDF_FILE LANG_CODE; do
              # Get display name from mapping, fallback to code
              LANG_DISPLAY="${LANG_NAMES[$LANG_CODE]:-$LANG_CODE}"

              # Use language code for URLs (en.pdf, pt.html, etc)
              echo "| $LANG_DISPLAY | [Preview](${PAGES_URL}${LANG_CODE}.html) | [Download](${PAGES_URL}${LANG_CODE}.pdf) |" >> $GITHUB_STEP_SUMMARY
            done < artifacts/lang_mapping.txt
          fi
